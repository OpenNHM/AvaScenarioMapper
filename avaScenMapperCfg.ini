# --------------------------- Avalanche Scenario Mapper --------------------------- #
#
# Purpose :
#   Filters avaDirectoryResults.parquet into scenario-specific subsets
#   for visualization, mapping, and publication.
#
# Usage :
#   - Standalone :  python runAvaScenMapper.py --cfg avaScenMapperCfg.ini
#   - Integrated :  Executed as Step 16 of the Avalanche Scenario Model Chain.
#
# Pixi environment :
#   pixi shell -e dev
#   pixi run -e dev python runAvaScenMapper.py
#
# Input  :  12_avaDirectory/avaDirectoryResults.parquet  (from Step 15)
# Output :  13_avaScenMaps/avaScen_<Scenario>.parquet / .geojson
#
# Workflow context :
#   Consumes Step 15 Avalanche Directory results and prepares
#   scenario-specific subsets for visualization and dissemination.
#
# Author :
#   Christoph Hesselbach
#
# Institution :
#   Austrian Research Centre for Forests (BFW)
#   Department of Natural Hazards | Snow and Avalanche Unit
#
# Version :
#   2025-11
#
# ---------------------------------------------------------------------------------- #



# ------------------ Workflow control ------------------ #
[WORKFLOW]

# Check only the available attributes in avaDirectoryResults.parquet
#   True  → print columns and exit (diagnostic mode)
#   False → continue full workflow
checkAvaDirResult = True

# Enable or disable the Scenario Mapper (Step 16)
mapperRun = True

# If True, merge all scenario results into one master dataset
mapperMakeMaster = False

# Log level (DEBUG, INFO, WARNING, ERROR)
logLevel = INFO

# Path resolution mode :
#   AvaScenDirectory : auto-resolve based on standard Model Chain folder tree
#   customPaths      : use explicit entries in [PATHS]
mapperPathMode = AvaScenDirectory

# Enable external CAAML JSON feed (not yet implemented)
mapperUseCaaml = False
#mapperCaamlURL  =
#mapperCaamlFile =



# ------------------ Path definitions ------------------ #
[PATHS]
# Base project directory (used when mapperPathMode = AvaScenDirectory)
baseDir = /path/to/AvaScenarioModelChain/Directory

# Optional explicit paths (used only when mapperPathMode = customPaths)
#avaDirectoryResults = /path/to/avaDirectoryResults.parquet
#avaScenMapsDir      = /path/to/output/avaScenMaps
#refTif              = /path/to/00_input/10DTM_projectName.tif



# --------------------------- Scenario definitions --------------------------- #
# Each [FILTER.<name>] defines one independent scenario.
#
# You can define as many scenario sections as required — each one
# representing a unique combination of region, flow type, elevation,
# and avalanche distribution/size potential. Example :
#     [FILTER.winter]
#     [FILTER.spring]
#     [FILTER.<....>]
#
# All active scenarios to be processed must be listed under :
#     [FILTER]
#     filters = winter, spring, ...
#
# --- Area filters ---
# Define administrative (LKGebietID) and forecast (LWDGebietID) regions.
# Both lists can be used together or individually.
# regionMode controls the logical combination :
#     or  → keep PRAs matching either LKGebietID or LWDGebietID  (union)
#     and → keep only PRAs matching both region filters           (intersection)
# If only one of the two region lists is provided, regionMode has no effect.
#
# --- Scenario filters ---
# Control physical and spatial filtering within the selected regions :
#   subC       : Subcatchment identifier (integer, e.g. 500)
#   sector     : Aspect / direction of potential release areas (E, N, S, W)
#   flow       : Flow type (dry / wet) defining the avalanche regime
#   elevMin / elevMax : Elevation band (m a.s.l.) restricting PRA selection
#                       to a specific vertical range
#
# --- Avalanche distribution & size potential ---
# Define the avalanche hazard and target scenario size class :
#   AvaDistributionPotential : Avalanche hazard potential level
#                              (very high, high, moderate, low)
#   AvaSizePotential         : Reference avalanche size scenario (2–5)
#                              formerly “PEM_header”
#   applySingleRsizeRule     : If True, deduplicates PRAs by keeping only
#                              the largest rSize variant per unique PRA
#
# --- Output ---
# During execution, each scenario will be filtered and exported
# separately as :
#     13_avaScenMaps/avaScen_<name>.parquet / .geojson
#
# The syntax and key names follow the Avalanche Scenario Model Chain
# convention and are parsed automatically by mapperUtils.parseFilterConfig().
# ---------------------------------------------------------------------------------- #


[FILTER]
# Active scenario filters (by section name)
filters = winter, spring


# ------------------ Scenario: Winter ------------------ #
[FILTER.winter]
name = Winter

# --- Area filters ---
LKRegionID  = 70601, 70602
LwdRegionID = IT-32-BZ-18-02, IT-32-TN-16
regionMode  = or

# --- Scenario filters ---
subC        = 500
sector      = E,N,S,W
flow        = dry
elevMin     = 1800
elevMax     = 5000

# --- Avalanche distribution & size potential ---
AvaDistributionPotential = very high
AvaSizePotential         = 5
applySingleRsizeRule     = True


# ------------------ Scenario: Spring ------------------ #
[FILTER.spring]
name = Spring

# --- Area filters ---
LKRegionID  = 70601, 70602
LwdRegionID = IT-32-BZ-18-02, IT-32-TN-16
regionMode  = or

# --- Scenario filters ---
subC        = 500
sector      = E,S,W
flow        = wet
elevMin     = 1800
elevMax     = 2200

# --- Avalanche distribution & size potential ---
AvaDistributionPotential = very high
AvaSizePotential         = 3
applySingleRsizeRule     = True
