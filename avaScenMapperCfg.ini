# ============================================================
# CAIROS Avalanche Scenario Mapper (Step 17)
# ============================================================
# Purpose:
#   Filters avaDirectoryResults.parquet into scenario-specific subsets
#   for visualization, mapping, and web export.
#
# Usage:
#   - Standalone:  python runAvaScenMapper.py --cfg avaScenMapperCfg.ini
#   - Integrated:  Executed as Step 17 from the CAIROS ModelChain.
#
# Pixi environment:
#   pixi shell -e dev
#   pixi run -e dev python runAvaScenMapper.py
#
# Input  :  12_avaDirectory/avaDirectoryResults.parquet  (from Step 15)
# Output :  13_avaScenMaps/avaScen_<Scenario>.parquet / .geojson
#
# Workflow context:
#   Consumes Step 15 avalanche directory results and prepares
#   scenario-specific subsets for visualization and publication.
#
# Author : CAIROS Project Team
# Version: 2025-11
# ============================================================



# ------------------ Workflow control ------------------ #
[WORKFLOW]

# Check only the available attributes in avaDirectoryResults.parquet
#   True  → print columns and exit (diagnostic mode)
#   False → continue full workflow
checkAvaDirResult = False

# Enable or disable the Scenario Mapper (Step 17)
mapperRun = True

# If True, merge all scenario results into one master dataset
mapperMakeMaster = False

# Log level (DEBUG, INFO, WARNING, ERROR)
logLevel = INFO

# Path resolution mode:
#   cairosPaths : auto-resolve based on standard CAIROS folder tree
#   customPaths : use explicit entries in [PATHS]
mapperPathMode = cairosPaths

# Enable external CAAML JSON feed (not yet implemented)
mapperUseCaaml = False
#mapperCaamlURL  = https://example.org/eaws/forecast/caamlv6.json
#mapperCaamlFile = ./demo_caaml_v6.json


# ------------------ Path definitions ------------------ #
[PATHS]
# Base project directory (used when mapperPathMode = cairosPaths)
baseDir = /media/christoph/Daten/Cairos/ModelChainProcess/cairosTutti/pilotSellaTest/alpha32_3_umax8_18_maxS5

# Optional explicit paths (used only when mapperPathMode = customPaths)
#avaDirectoryResults = /path/to/avaDirectoryResults.parquet
#avaScenMapsDir      = /path/to/output/avaScenMaps
#refTif              = /path/to/00_input/10DTM_projectName.tif



# ============================================================
# Scenario definitions
# ============================================================
# Each [FILTER.<name>] defines one independent scenario.
#
# You can define as many scenario sections as required — each one
# representing a unique combination of region, flow type, elevation,
# and avalanche potential. For example:
#     [FILTER.winter]
#     [FILTER.spring]
#     [FILTER.highRiskMultiRegion]
#
# All active scenarios to be processed must be listed under:
#     [FILTER]
#     filters = winter, spring, ...
#
# --- Area filters ---
# Define administrative (LKGebietID) and forecast (areaLWDID) regions.
# Both lists can be used together or individually.
# areaMode controls the logical combination:
#     or  → keep PRAs matching either LKGebietID or LWDGebietID  (union)
#     and → keep only PRAs matching both region filters           (intersection)
# If only one of the two region lists is provided, areaMode has no effect.
#
# --- Scenario filters ---
# Control physical and spatial filtering within the selected regions:
#   subC       : Subcatchment identifier (integer, e.g. 500) used to
#                select modelled catchments of matching scale or ID.
#   sector     : Aspect / direction of potential release areas (E, N, S, W).
#                Multiple entries can be listed, comma-separated.
#   flow       : Flow type (dry / wet) defining the avalanche regime.
#   elevMin / elevMax : Elevation band (m a.s.l.) restricting PRA selection
#                       to a specific vertical range.
#
# --- Avalanche potential & size ---
# Define the avalanche magnitude class to include in the scenario:
#   avaPotential : Avalanche potential derived from EAWS-Matrix (e.g. low, medium, high, very high)
#   avaSize      : Target potential event mobility size 
#   applySingleRsizeRule : If True, deduplicates PRAs by keeping only
#                          the largest rSize variant per unique PRA.
#
# --- Output ---
# During execution, each scenario will be filtered and exported
# separately as:
#     13_avaScenMaps/avaScen_<name>.parquet / .geojson
#
# The syntax and key names follow the CAIROS ModelChain convention
# and are parsed automatically by mapperUtils.parseFilterConfig().
# ============================================================


[FILTER]
# Active scenario filters (by section name)
filters = winter, spring

# ------------------ Scenario: Winter ------------------ #
[FILTER.winter]
name = Winter

# --- Area filters ---
LKRegionID = 70601, 70602
LwdRegionID  = IT-32-BZ-18-02, IT-32-TN-16
regionMode   = or

# --- Scenario filters ---
subC        = 500
sector      = E,N,S,W
flow        = dry
elevMin     = 1800
elevMax     = 5000

# --- Avalanche potential & size ---
avaPotential = very high
avaSize      = 5
applySingleRsizeRule = True


# ------------------ Scenario: Spring ------------------ #
[FILTER.spring]
name = Spring

# --- Area filters ---
LKRegionID = 70601, 70602
LwdRegionID  = IT-32-BZ-18-02, IT-32-TN-16
regionMode   = or

# --- Scenario filters ---
subC        = 500
sector      = E,S,W
flow        = wet
elevMin     = 1800
elevMax     = 2200

# --- Avalanche potential & size ---
avaPotential = very high
avaSize      = 3
applySingleRsizeRule = True